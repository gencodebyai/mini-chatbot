### 逐步实现任务

#### 步骤 1：调整项目基础结构
- **目标**：确保前后端代码结构清晰，支持后续开发。
- **前端任务**：
  1. 检查现有前端框架（React/Vue），确保主组件为单页应用（SPA）。
  2. 创建基础布局：
     - 主容器分为左右两栏：左侧占20%（历史聊天列表），右侧占80%（当前聊天窗口）。
     - 使用 CSS（如 Tailwind）设置基本样式：flex布局，高度100vh。
  3. 添加响应式支持：移动端时左侧折叠为抽屉（用按钮触发）。
- **后端任务**：
  1. 检查现有 Express.js 服务器，确保运行正常。
  2. 移除数据库相关代码（若有），确认后端仅处理API请求。
  3. 确保已有路由 `/api/chat` 和 `/api/upload` 可响应简单请求（如返回固定字符串）。

---

#### 步骤 2：实现历史聊天列表（左侧）
- **目标**：显示历史会话列表，标题初始化为"新会话"。
- **前端任务**：
  1. 创建 `ChatList` 组件，放在左侧栏。
  2. 初始化 `localStorage` 数据：
     - 检查 `localStorage.getItem('chat_list')`，若无则设为空数组：
       ```json
       { "chats": [] }
       ```
  3. 渲染会话列表：
     - 从 `chat_list` 读取数据，按 `timestamp` 倒序排列。
     - 每项显示：标题（`title`）、最后消息（`lastMessage`）、时间戳（格式：今天 HH:mm）。
     - 示例样式：灰色背景，悬浮高亮。
  4. 添加"新建聊天"按钮：
     - 顶部"+"图标，点击生成新 `chat_id`（如 `chat_时间戳`）。
     - 新增会话数据：
       ```json
       { "id": "chat_时间戳", "title": "新会话", "lastMessage": "", "timestamp": 当前时间 }
       ```
     - 保存到 `chat_list`，刷新列表。

---

#### 步骤 3：实现当前聊天窗口基础（右侧）
- **目标**：搭建右侧聊天窗口框架，显示标题和消息区。
- **前端任务**：
  1. 创建 `ChatWindow` 组件，放在右侧栏。
  2. 分三部分：
     - 上面，模型选择，导出记录
     - 中间，消息展示区，初始为空（占剩余高度，带滚动条）。
     - 下面，输入区，包含文本框和发送按钮。
  3. 初始化当前会话：
     - 定义状态 `currentChatId`，新建聊天时设为新 `chat_id`。
     - 检查 `localStorage.getItem('chat_[currentChatId]')`，若无则设为空数组：
       ```json
       []
       ```
  4. 渲染标题：
     - 从 `chat_list` 获取 `currentChatId` 对应的 `title`，显示在顶部。

---

#### 步骤 4：实现消息发送与标题更新
- **目标**：用户发送消息，标题变为第一个问题，存储到 `localStorage`。
- **前端任务**：
  1. 在输入区添加发送逻辑：
     - 文本框绑定输入值，点击发送按钮（纸飞机图标）或按 Enter 触发。
  2. 处理消息发送：
     - 获取输入内容，生成消息对象：
       ```json
       { "id": "msg_时间戳", "sender": "user", "content": 输入内容, "timestamp": 当前时间, "type": "text" }
       ```
     - 检查是否为第一条消息：
       - 若 `chat_[currentChatId]` 为空：
         - 更新 `chat_list` 中 `title` 为输入内容。
         - 更新顶部标题显示。
       - 更新 `lastMessage` 为输入内容。
     - 将消息追加到 `chat_[currentChatId]`，保存到 `localStorage`。

---

#### 步骤 5：集成 AI 回复功能
- **目标**：调用后端 API 获取 AI 回复并显示。
- **后端任务**：
  1. 实现 `/api/chat` 接口：
     - 接收请求：`{ message: "用户输入", context: [] }`（初始无上下文）。
     - 调用 AI 接口（假设已有），返回回复。
     - 响应：`{ response: "AI回复", timestamp: 当前时间 }`。
- **前端任务**：
  1. 发送请求：
     - 用户消息发送后，调用 `/api/chat`，附带用户输入。
     - 请求前显示"正在思考..."（灰色气泡）。
  2. 处理回复：
     - 收到响应后，移除"正在思考..."。
     - 生成 AI 消息：
       ```json
       { "id": "msg_时间戳", "sender": "ai", "content": AI回复, "timestamp": 后端返回时间, "type": "text" }
       ```
     - 追加到 `chat_[currentChatId]`，更新 `lastMessage`，保存到 `localStorage`。

---

#### 步骤 6：支持上下文对话
- **目标**：AI 回复带上前5条消息上下文。
- **前端任务**：
  1. 修改发送逻辑：
     - 从 `chat_[currentChatId]` 获取最新5条消息，作为 `context`。
     - 请求 `/api/chat` 时附带：`{ message: 输入内容, context: 前5条消息 }`。
- **后端任务**：
  1. 更新 `/api/chat`：
     - 接收 `context`，与 `message` 一起传给 AI 接口。
     - 确保 AI 根据上下文生成回复。

---

#### 步骤 7：实现标题编辑
- **目标**：用户可手动编辑会话标题。
- **前端任务**：
  1. 顶部标题点击变输入框：
     - 显示当前 `title`，可编辑。
  2. 保存编辑：
     - 失焦或按 Enter 时，更新 `chat_list` 中对应 `chat_id` 的 `title`。
     - 保存到 `localStorage`，刷新显示。

---

#### 步骤 8：添加删除和清空功能
- **目标**：支持删除会话和清空聊天。
- **前端任务**：
  1. 删除会话：
     - 左侧每项添加"×"图标（悬浮显示）。
     - 点击后移除 `chat_list` 中对应项和 `chat_[currentChatId]`，保存 `localStorage`。
     - Toast 提示"已删除"（2秒）。
  2. 清空聊天：
     - 顶部添加垃圾桶图标。
     - 点击清空 `chat_[currentChatId]` 消息数组，标题保留，保存 `localStorage`。

---

#### 步骤 9：支持图片上传
- **目标**：用户可上传图片并显示。
- **后端任务**：
  1. 实现 `/api/upload`：
     - 使用 multer 处理上传，存储到 `/uploads/YYYYMMDD/`。
     - 返回：`{ url: "http://domain/uploads/YYYYMMDD/filename.jpg" }`。
- **前端任务**：
  1. 输入区添加夹子图标：
     - 点击打开文件选择（jpg/png）。
     - 上传后显示预览，点击发送调用 `/api/upload`。
  2. 处理图片消息：
     - 收到 URL 后，生成消息：
       ```json
       { "id": "msg_时间戳", "sender": "user", "content": URL, "timestamp": 当前时间, "type": "image" }
       ```
     - 更新 `lastMessage` 为"[图片]"，保存 `localStorage`。
  3. 渲染图片：
     - 显示缩略图（最大300px），点击放大。

---

#### 步骤 10：优化体验
- **目标**：提升界面和交互体验。
- **前端任务**：
  1. 添加加载动画：
     - AI 回复时显示"正在思考..."（灰色气泡，跳动点）。
  2. 性能优化：
     - 消息区初次加载20条，滚动加载更多。
     - 图片懒加载。
  3. 用户反馈：
     - 发送成功后消息气泡淡绿色高亮（0.5秒）。
  4. 添加"清理历史"按钮：
     - 右上角，点击清空 `localStorage`，弹窗确认。

---

### 优化需求清单

#### 1. 消息列表优化
- 实现消息分页加载（初始显示20条，滚动到顶部时加载更多）
- 添加消息状态指示（发送中/失败/重试）
- 长消息折叠功能（超过3行显示"展开"按钮）
- 添加消息类型标记（文本/图片/文件）
- 优化消息时间戳显示（精确到秒）

#### 2. 上下文管理增强
- 自动维护对话上下文（保留最近5条消息）
- 添加token计算功能（显示当前对话消耗token数）
- 支持自定义系统提示词
- 添加上下文清理按钮（一键清除历史上下文）

#### 3. 标题编辑功能
- 双击标题进入编辑模式
- 编辑时显示字数统计（最大50字）
- 添加防误触机制（2秒内不能重复编辑）
- 标题修改后同步更新所有相关会话

#### 4. 文件上传增强
- 支持拖拽上传文件
- 添加文件类型限制（jpg/png/pdf）
- 显示上传进度条
- 实现文件预览功能（图片缩放、PDF阅读）
- 添加文件清理机制（7天未访问自动删除）

#### 5. 性能优化
- 实现虚拟滚动列表（万条消息流畅滚动）
- 添加本地缓存策略（最近对话优先加载）
- 使用Web Worker处理本地存储操作
- 优化流式响应处理（减少渲染次数）

#### 6. 智能会话管理
- 自动清理旧会话（保留最近50个）
- 添加会话标签系统（工作/学习/娱乐）
- 实现会话搜索功能（标题/内容关键词）
- 添加会话归档功能（重要对话加星标）

#### 7. 调试与监控
- 添加实时性能监控面板
- 显示API调用统计（成功率/响应时间）
- 记录错误日志并支持导出
- 添加网络状态检测（离线提醒）

#### 8. 安全增强
- 添加敏感词过滤系统
- 实现端到端加密（可选）
- 添加双因素认证（管理界面）
- 完善速率限制策略（IP/用户级）

#### 9. 用户体验优化
- 添加消息发送动画
- 实现消息引用功能
- 支持消息表情反应
- 添加快捷键支持（Ctrl+N新建等）
- 实现深色模式切换

#### 10. 多平台支持
- 开发PWA版本（支持离线使用）
- 打包Electron桌面客户端
- 开发移动端适配布局
- 添加浏览器扩展支持

---
